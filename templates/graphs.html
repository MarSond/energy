{% extends 'base.html' %}

{% block sub_nav %}
<nav class="nav nav-tabs">
    <a class="nav-item nav-link {% if active_sub_tab == 'all' %}active{% endif %}" href="{{ url_for('graphs', type='all') }}">All</a>
    <a class="nav-item nav-link {% if active_sub_tab == 'strom' %}active{% endif %}" href="{{ url_for('graphs', type='strom') }}">Strom</a>
    <a class="nav-item nav-link {% if active_sub_tab == 'wasser' %}active{% endif %}" href="{{ url_for('graphs', type='wasser') }}">Wasser</a>
    <a class="nav-item nav-link {% if active_sub_tab == 'gas' %}active{% endif %}" href="{{ url_for('graphs', type='gas') }}">Gas</a>
</nav>
{% endblock %}

{% block title %}Graphen - {{ type | capitalize }}{% endblock %}


{% block content %}
<h2>Energie-Dashboard: Graphen und Details</h2>
<canvas id="energyChart" width="400" height="400"></canvas>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var ctx = document.getElementById('energyChart').getContext('2d');
        var energyChart = null;  // Declare chart variable to update or destroy it as needed
    
        function fetchDataAndUpdateChart(resourceType) {
            fetch(`/api/data/${resourceType}`)
                .then(response => response.json())
                .then(data => {
                    // Check if data is in the expected format (array of objects)
                    if (!Array.isArray(data) || data.length === 0 || !data[0].hasOwnProperty('label')) {
                        console.error('Data format error or data is empty');
                        return;
                    }
    
                    var labels = data.map(item => item.label);
                    var dataValues = data.map(item => item.value);
    
                    var chartData = {
                        labels: labels,
                        datasets: [{
                            label: `${resourceType.charAt(0).toUpperCase() + resourceType.slice(1)} Verbrauch`,
                            data: dataValues,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    };
    
                    if (energyChart) {
                        energyChart.destroy();  // Destroy the existing chart before creating a new one
                    }
    
                    energyChart = new Chart(ctx, {
                        type: 'line',
                        data: chartData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        }
    
        // Fetch data based on the current active type, passed from Flask
        fetchDataAndUpdateChart('{{ active_sub_tab }}');  
    });
    </script>
    
    
{% endblock %}
